disparity_range = [-16 16];
im_reference  = rgb2gray(imread('image_left.png'));
im_support  = rgb2gray(imread('image_right.png'));

% output image:
C = zeros(size(im_support,1), size(im_reference,2), disparity_range(2) - disparity_range(1) + 1, 'double');

% allocate im_diff. im_diff is in left coords:
im_diff = zeros(size(im_reference, 1), size(im_reference,2), 'double');

for disp = 0
    
    % calc borders for images
    init = [1, size(im_reference,2)];
    borders_left = [1, size(im_reference,2)] - disp*  [(disp < 0), disp > 0];
    disp(disp<0)       
    borders_right = borders_left + [disp, disp];
    
    % im_diff = (im_left - im_reference).^2, inside borders
    im_diff(:, borders_left(1) : borders_left(2)) = ...
        im_support(:, borders_left(1) : borders_left(2)) - ...
        im_reference(:, borders_right(1) : borders_right(2));
    im_diff = abs(im_diff);
    
end